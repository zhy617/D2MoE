==================================================
               Running Latency Test
==================================================
Running 5 warm-up rounds...
Traceback (most recent call last):
  File "/home/tom/D2MoE/D2-qwen.py", line 328, in <module>
    main()
  File "/home/tom/D2MoE/D2-qwen.py", line 48, in main
    runExperiment()
  File "/home/tom/D2MoE/D2-qwen.py", line 236, in runExperiment
    _ = model.generate(
        ^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/utils/_contextlib.py", line 115, in decorate_context
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/transformers/generation/utils.py", line 1914, in generate
    result = self._sample(
             ^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/transformers/generation/utils.py", line 2651, in _sample
    outputs = self(
              ^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1532, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1541, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/accelerate/hooks.py", line 166, in new_forward
    output = module._old_forward(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/transformers/models/qwen2_moe/modeling_qwen2_moe.py", line 1400, in forward
    outputs = self.model(
              ^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1532, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1541, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/transformers/models/qwen2_moe/modeling_qwen2_moe.py", line 1186, in forward
    layer_outputs = decoder_layer(
                    ^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1532, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1541, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/accelerate/hooks.py", line 166, in new_forward
    output = module._old_forward(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/transformers/models/qwen2_moe/modeling_qwen2_moe.py", line 923, in forward
    hidden_states = self.mlp(hidden_states)
                    ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1532, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1541, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/model/merge_qwen.py", line 145, in forward
    current_hidden_states = expert_layer(current_state) * routing_weights[top_x, idx, None]
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1532, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1541, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/model/merge_qwen.py", line 878, in forward
    probe_out_dim_indices, probe_out = self.probe_process(x, **kwargs)
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/model/merge_qwen.py", line 765, in probe_process
    probe_out = self.act_fn( self.Wmean_gate(probe, cal_mlp_probe_out_dim_metric=True) ) * \
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1532, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/tom/D2MoE/.venv/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1541, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: Linear.forward() got an unexpected keyword argument 'cal_mlp_probe_out_dim_metric'